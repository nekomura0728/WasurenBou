# わすれん棒 - 技術要件書（MVP）

## 1. 技術スタック概要

### 1.1 開発環境
- **IDE**: Xcode 16.0以上
- **言語**: Swift 5.9以上
- **最小対応**: iOS 16.0（Apple Watch連携は当面非対応）
- **アーキテクチャ**: MVVM + Combine
- **UI**: SwiftUI

### 1.2 主要フレームワーク
```swift
import SwiftUI
import Combine
import CoreData
import UserNotifications
import Speech
import NaturalLanguage
import Intents           // Siri Shortcuts
```

## 2. データ層設計

### 2.1 Core Dataモデル
```swift
// Reminder.xcdatamodeld
entity Reminder {
    id: UUID
    title: String
    scheduledTime: Date
    isCompleted: Bool
    createdAt: Date
    reminderType: String  // "once", "daily", "weekly"
    notificationIdentifiers: [String]  // 複数通知ID
    completedAt: Date?
    userId: String?
}

entity ReminderTemplate {
    id: UUID
    title: String
    emoji: String
    usageCount: Int32
    lastUsed: Date
}
```

### 2.2 データアクセス層
```swift
protocol ReminderRepositoryProtocol {
    func saveReminder(_ reminder: Reminder) async throws
    func fetchActiveReminders() async -> [Reminder]
    func markAsCompleted(_ reminder: Reminder) async throws
    func deleteReminder(_ reminder: Reminder) async throws
}

class CoreDataReminderRepository: ReminderRepositoryProtocol {
    private let container: NSPersistentContainer
    // iCloud Core Data同期対応
}
```

## 3. 音声入力システム

### 3.1 Speech Framework実装
```swift
import Speech

class SpeechRecognitionService: ObservableObject {
    private let speechRecognizer = SFSpeechRecognizer(locale: Locale(identifier: "ja-JP"))
    private let audioEngine = AVAudioEngine()
    
    @Published var isRecording = false
    @Published var recognizedText = ""
    
    func requestPermission() async -> Bool {
        await withCheckedContinuation { continuation in
            SFSpeechRecognizer.requestAuthorization { status in
                continuation.resume(returning: status == .authorized)
            }
        }
    }
    
    func startRecording() throws {
        // マイク入力開始
        // リアルタイム音声認識
    }
    
    func stopRecording() {
        // 音声認識停止
        // 結果をNLPパーサーに送信
    }
}
```

### 3.2 自然言語処理
```swift
import NaturalLanguage

struct ReminderIntent {
    let title: String
    let scheduledTime: Date
    let reminderType: ReminderType
}

class NLPParser {
    private let tagger = NLTagger(tagSchemes: [.tokenType, .lexicalClass])
    
    func parseReminderIntent(from text: String) -> ReminderIntent? {
        // "2時間後に洗濯物取り込む" -> ReminderIntent
        let timeExtractor = TimeExpressionExtractor()
        let actionExtractor = ActionExtractor()
        
        guard let timeInfo = timeExtractor.extract(from: text),
              let action = actionExtractor.extract(from: text) else {
            return nil
        }
        
        return ReminderIntent(
            title: action,
            scheduledTime: timeInfo.absoluteTime,
            reminderType: timeInfo.type
        )
    }
}

class TimeExpressionExtractor {
    // "2時間後" -> Date(now + 2hours)
    // "明日朝一" -> Date(tomorrow 8:00)
    // "来週火曜日" -> Date(next tuesday)
}
```

## 4. 通知システム

### 4.1 段階的通知実装
```swift
import UserNotifications

class NotificationService {
    func scheduleEscalatingReminders(for reminder: Reminder) async throws {
        let center = UNUserNotificationCenter.current()
        
        // 1回目: 優しい通知
        let firstNotification = createNotification(
            identifier: "\(reminder.id)-1",
            title: reminder.title,
            body: "時間ですよ〜",
            date: reminder.scheduledTime,
            sound: .gentle
        )
        
        // 2回目: 少し強い通知（5分後）
        let secondNotification = createNotification(
            identifier: "\(reminder.id)-2", 
            title: reminder.title,
            body: "大丈夫ですか？",
            date: reminder.scheduledTime.addingTimeInterval(300),
            sound: .moderate
        )
        
        // 3回目: 強い通知（10分後）
        let thirdNotification = createNotification(
            identifier: "\(reminder.id)-3",
            title: reminder.title, 
            body: "！！",
            date: reminder.scheduledTime.addingTimeInterval(600),
            sound: .urgent,
            critical: true
        )
        
        try await center.add(firstNotification)
        try await center.add(secondNotification) 
        try await center.add(thirdNotification)
    }
    
    private func createNotification(
        identifier: String,
        title: String, 
        body: String,
        date: Date,
        sound: NotificationSound,
        critical: Bool = false
    ) -> UNNotificationRequest {
        let content = UNMutableNotificationContent()
        content.title = title
        content.body = body
        content.categoryIdentifier = "REMINDER"
        
        if critical {
            content.sound = .defaultCritical
            content.interruptionLevel = .critical
        } else {
            content.sound = sound.unSound
        }
        
        // カスタムアクション
        content.userInfo = ["reminderId": identifier]
        
        let trigger = UNCalendarNotificationTrigger(
            dateMatching: Calendar.current.dateComponents([.year, .month, .day, .hour, .minute], from: date),
            repeats: false
        )
        
        return UNNotificationRequest(identifier: identifier, content: content, trigger: trigger)
    }
}

enum NotificationSound {
    case gentle, moderate, urgent
    
    var unSound: UNNotificationSound {
        switch self {
        case .gentle: return UNNotificationSound(named: UNNotificationSoundName("gentle.caf"))
        case .moderate: return .default
        case .urgent: return .defaultCritical
        }
    }
}
```

### 4.2 通知アクション
```swift
// NotificationActionの設定
func setupNotificationCategories() {
    let completeAction = UNNotificationAction(
        identifier: "COMPLETE",
        title: "完了！",
        options: []
    )
    
    let snooze5Action = UNNotificationAction(
        identifier: "SNOOZE_5",
        title: "あと5分",
        options: []
    )
    
    let snooze15Action = UNNotificationAction(
        identifier: "SNOOZE_15", 
        title: "あと15分",
        options: []
    )
    
    let category = UNNotificationCategory(
        identifier: "REMINDER",
        actions: [completeAction, snooze5Action, snooze15Action],
        intentIdentifiers: [],
        options: []
    )
    
    UNUserNotificationCenter.current().setNotificationCategories([category])
}
```

## 5. Apple Watch連携
当面は非対応。将来対応時に別仕様として定義します。

## 6. UI実装（SwiftUI）

### 6.1 メイン画面
```swift
struct ContentView: View {
    @StateObject private var viewModel = ReminderViewModel()
    @StateObject private var speechService = SpeechRecognitionService()
    
    var body: some View {
        NavigationView {
            VStack(spacing: 20) {
                // 音声入力ボタン
                VoiceInputButton(speechService: speechService) { recognizedText in
                    viewModel.createReminderFromText(recognizedText)
                }
                
                // 今日のリマインダー一覧
                ReminderListView(reminders: viewModel.todayReminders) { reminder in
                    viewModel.completeReminder(reminder)
                }
                
                // よく使うテンプレート
                TemplateGridView(templates: viewModel.templates) { template in
                    viewModel.createReminderFromTemplate(template)
                }
                
                Spacer()
            }
            .padding()
            .navigationTitle("わすれん棒")
        }
    }
}

struct VoiceInputButton: View {
    @ObservedObject var speechService: SpeechRecognitionService
    let onRecognized: (String) -> Void
    
    var body: some View {
        Button(action: {
            if speechService.isRecording {
                speechService.stopRecording()
                onRecognized(speechService.recognizedText)
            } else {
                try? speechService.startRecording()
            }
        }) {
            Image(systemName: speechService.isRecording ? "stop.circle.fill" : "mic.circle.fill")
                .font(.system(size: 60))
                .foregroundColor(speechService.isRecording ? .red : .blue)
        }
        .disabled(!speechService.isAuthorized)
    }
}
```

### 6.2 リマインダーリスト
```swift
struct ReminderListView: View {
    let reminders: [Reminder]
    let onComplete: (Reminder) -> Void
    
    var body: some View {
        LazyVStack(spacing: 12) {
            ForEach(reminders) { reminder in
                ReminderCard(reminder: reminder, onComplete: onComplete)
            }
        }
    }
}

struct ReminderCard: View {
    let reminder: Reminder
    let onComplete: (Reminder) -> Void
    
    var urgencyColor: Color {
        let timeLeft = reminder.scheduledTime.timeIntervalSinceNow
        if timeLeft <= 0 { return .red }
        if timeLeft <= 300 { return .orange }  // 5分以内
        return .green
    }
    
    var body: some View {
        HStack {
            Circle()
                .fill(urgencyColor)
                .frame(width: 12, height: 12)
            
            VStack(alignment: .leading) {
                Text(reminder.title)
                    .font(.body)
                
                Text(reminder.scheduledTime, style: .time)
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            
            Spacer()
            
            Button("完了") {
                onComplete(reminder)
            }
            .buttonStyle(.borderedProminent)
            .font(.caption)
        }
        .padding()
        .background(Color(.systemGray6))
        .cornerRadius(12)
    }
}
```

## 7. MVVM + Combine実装

### 7.1 ViewModelクラス
```swift
class ReminderViewModel: ObservableObject {
    @Published var todayReminders: [Reminder] = []
    @Published var templates: [ReminderTemplate] = []
    @Published var isLoading = false
    
    private let repository: ReminderRepositoryProtocol
    private let notificationService: NotificationService
    private let nlpParser: NLPParser
    private var cancellables = Set<AnyCancellable>()
    
    init(repository: ReminderRepositoryProtocol = CoreDataReminderRepository()) {
        self.repository = repository
        self.notificationService = NotificationService()
        self.nlpParser = NLPParser()
        
        loadTodayReminders()
        loadTemplates()
    }
    
    func createReminderFromText(_ text: String) {
        guard let intent = nlpParser.parseReminderIntent(from: text) else {
            // パースエラー処理
            return
        }
        
        let reminder = Reminder(
            title: intent.title,
            scheduledTime: intent.scheduledTime,
            reminderType: intent.reminderType
        )
        
        Task {
            do {
                try await repository.saveReminder(reminder)
                try await notificationService.scheduleEscalatingReminders(for: reminder)
                await MainActor.run {
                    loadTodayReminders()
                }
            } catch {
                // エラー処理
            }
        }
    }
    
    func completeReminder(_ reminder: Reminder) {
        Task {
            try await repository.markAsCompleted(reminder)
            await MainActor.run {
                loadTodayReminders()
                // 完了時の褒めメッセージ表示
                showCompletionMessage()
            }
        }
    }
    
    private func loadTodayReminders() {
        Task {
            let reminders = await repository.fetchActiveReminders()
            await MainActor.run {
                self.todayReminders = reminders.filter { Calendar.current.isDateInToday($0.scheduledTime) }
            }
        }
    }
}
```

## 8. 開発環境セットアップ

### 8.1 プロジェクト構成
```
WasurenBou/
├── WasurenBou/                 # iOS App
│   ├── Views/
│   ├── ViewModels/
│   ├── Models/
│   ├── Services/
│   └── Resources/
├── WasurenBouWatch/            # watchOS App
│   ├── Views/
│   └── Services/
├── WasurenBouWatchExtension/   # Watch Extension
└── Shared/                     # 共通コード
    ├── Models/
    └── Extensions/
```

### 8.2 必要な設定
```swift
// Info.plist設定
<key>NSMicrophoneUsageDescription</key>
<string>音声でリマインダーを作成するためにマイクを使用します</string>

<key>NSSpeechRecognitionUsageDescription</key>  
<string>音声をテキストに変換してリマインダーを作成します</string>

// Capabilities
- Background Modes: Background processing
- Push Notifications
- Siri
```

### 8.3 依存関係管理（Swift Package Manager）
```swift
// Package.swift
dependencies: [
    .package(url: "https://github.com/realm/realm-swift.git", from: "10.0.0"), // Optional
]
```

これで技術要件が整理できました！次は具体的にどの機能から実装を始めたいでしょうか？

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"id": "1", "content": "MVP\u958b\u767a\u306e\u6280\u8853\u8981\u4ef6\u6574\u7406", "status": "completed"}, {"id": "2", "content": "\u97f3\u58f0\u5165\u529b\u30b7\u30b9\u30c6\u30e0\u306e\u6280\u8853\u4ed5\u69d8", "status": "completed"}, {"id": "3", "content": "\u901a\u77e5\u30b7\u30b9\u30c6\u30e0\u306e\u6280\u8853\u4ed5\u69d8", "status": "completed"}, {"id": "4", "content": "Apple Watch\u9023\u643a\u306e\u6280\u8853\u4ed5\u69d8", "status": "completed"}, {"id": "5", "content": "\u958b\u767a\u74b0\u5883\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7", "status": "completed"}]